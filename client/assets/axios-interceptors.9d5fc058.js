var A=Object.defineProperty;var m=(n,t,s)=>t in n?A(n,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):n[t]=s;var h=(n,t,s)=>(m(n,typeof t!="symbol"?t+"":t,s),s);import{u as d,k as S}from"./index.d170d1c9.js";import{eventBus as l,EVENT_AUTH as f}from"./event-bus.dc90e417.js";import{a as w}from"./axios.49e4da64.js";import{U as T,a as U,b as R}from"./api.constants.50d10b3a.js";import{A as p}from"./index.e92490f7.js";import"./mitt.550594b0.js";class _{constructor(){}async fetchRefresh(t){const u=U+T,o=new AbortController,i=()=>{o.abort()};return{axiosPromise:w.post(u,void 0,{signal:o.signal,headers:{Authorization:`Bearer ${t}`}}).then(r=>{const a=r.status;if(a===401&&l.emit(f.REFRESH_TOKEN_UNVALIDATED),a===201){const c=r.data;return l.emit(f.REFRESH_TOKEN_REFRESHED,c),{status:a,data:c}}return{status:a,data:null}}),cancel:i}}}class P{constructor(){h(this,"userStore",d());h(this,"tokensAPi",new _)}validateExpiration(t,s){const o=Math.floor(Date.now()/1e3);if(o<t)return!1;const i=o-t,e=s-i;return i<s&&e>5}async extractAccessToken(){const t=this.userStore.$state.accessToken;return t?this.validateExpiration(t.iat,t.exp)?t.token:(this.userStore.clearAccessToken(),null):null}async extractRefreshToken(){const t=this.userStore.$state.refreshToken;return t?this.validateExpiration(t.iat,t.exp)?t.token:(this.userStore.clearRefreshToken(),null):null}async refreshTokens(){const t=await this.extractRefreshToken();if(!t)return l.emit(f.REFRESH_TOKEN_UNVALIDATED),null;const s=await this.tokensAPi.fetchRefresh(t),u=s.axiosPromise,o=s.cancel;return l.on(f.LOGOUT_SUCCESS,o),u.then(i=>(l.off(f.LOGOUT_SUCCESS,o),i.data))}async getAccessTokenAndRefresh(){const t=await this.extractAccessToken();if(t)return t;const s=await this.refreshTokens();return s?s.access_token.token:null}}var N=S(({app:n,store:t})=>{n.config.globalProperties.$api;const s=new P;async function u(e){const r=e.url;if(!e.baseURL||!r)throw new p(`axios:${e.baseURL,r}`);if(r===T)throw new p(T+" endpoint should not be fetched with this instance!");return e}async function o(e){var E;const r=e.params;if((E=r&&r[R])!=null?E:!1)return e;const c=await s.getAccessTokenAndRefresh();if(c)return e.headers.Authorization=`Bearer ${c}`,e;const k=new AbortController;return e.signal=k.signal,k.abort(),e}async function i(e){if(!e.params)return e;const a=Object.entries(e.params).filter(c=>c[0]!==R);return e.params=Object.fromEntries(a),e}n.config.globalProperties.$api.interceptors.request.use(async e=>{let r;return r=await u(e),r=await o(e),r=await i(e),r},e=>(console.error(e.toString()),Promise.reject(e))),n.config.globalProperties.$api.interceptors.response.use(e=>e,e=>{if(e instanceof p){const r=e.response,a=r==null?void 0:r.status;a&&a===401&&s.refreshTokens()}return Promise.reject(e)})});export{N as default};

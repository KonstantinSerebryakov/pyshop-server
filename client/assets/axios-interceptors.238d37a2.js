var m=Object.defineProperty;var A=(n,t,r)=>t in n?m(n,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):n[t]=r;var h=(n,t,r)=>(A(n,typeof t!="symbol"?t+"":t,r),r);import{u as d,k as w}from"./index.5c38e1b7.js";import{eventBus as l,EVENT_AUTH as f}from"./event-bus.22b98288.js";import{b as S,a as U}from"./axios.d501ec61.js";import{c as T,U as E}from"./ApiConstants.1f91d7b3.js";import{A as p}from"./index.f77dea2c.js";import"./mitt.550594b0.js";class b{constructor(){}async fetchRefresh(t){const u=S.defaults.baseURL+T,o=new AbortController,i=()=>{o.abort()};return{axiosPromise:U.post(u,void 0,{signal:o.signal,headers:{Authorization:`Bearer ${t}`}}).then(s=>{const a=s.status;if(a===401&&l.emit(f.REFRESH_TOKEN_UNVALIDATED),a===201){const c=s.data;return l.emit(f.REFRESH_TOKEN_REFRESHED,c),{status:a,data:c}}return{status:a,data:null}}),cancel:i}}}class P{constructor(){h(this,"userStore",d());h(this,"tokensAPi",new b)}validateExpiration(t,r){const o=Math.floor(Date.now()/1e3);if(o<t)return!1;const i=o-t,e=r-i;return i<r&&e>5}async extractAccessToken(){const t=this.userStore.$state.accessToken;return t?this.validateExpiration(t.iat,t.exp)?t.token:(this.userStore.clearAccessToken(),null):null}async extractRefreshToken(){const t=this.userStore.$state.refreshToken;return t?this.validateExpiration(t.iat,t.exp)?t.token:(this.userStore.clearRefreshToken(),null):null}async refreshTokens(){const t=await this.extractRefreshToken();if(!t)return l.emit(f.REFRESH_TOKEN_UNVALIDATED),null;const r=await this.tokensAPi.fetchRefresh(t),u=r.axiosPromise,o=r.cancel;return l.on(f.LOGOUT_SUCCESS,o),u.then(i=>(l.off(f.LOGOUT_SUCCESS,o),i.data))}async getAccessTokenAndRefresh(){const t=await this.extractAccessToken();if(t)return t;const r=await this.refreshTokens();return r?r.access_token.token:null}}var v=w(({app:n,store:t})=>{n.config.globalProperties.$api;const r=new P;async function u(e){const s=e.url;if(!e.baseURL||!s)throw new p(`axios:${e.baseURL,s}`);if(s===T)throw new p(T+" endpoint should not be fetched with this instance!");return e}async function o(e){var R;const s=e.params;if((R=s&&s[E])!=null?R:!1)return e;const c=await r.getAccessTokenAndRefresh();if(c)return e.headers.Authorization=`Bearer ${c}`,e;const k=new AbortController;return e.signal=k.signal,k.abort(),e}async function i(e){if(!e.params)return e;const a=Object.entries(e.params).filter(c=>c[0]!==E);return e.params=Object.fromEntries(a),e}n.config.globalProperties.$api.interceptors.request.use(async e=>{let s;return s=await u(e),s=await o(e),s=await i(e),s},e=>(console.error(e.toString()),Promise.reject(e))),n.config.globalProperties.$api.interceptors.response.use(e=>e,e=>{if(e instanceof p){const s=e.response,a=s==null?void 0:s.status;a&&a===401&&r.refreshTokens()}return Promise.reject(e)})});export{v as default};

var A=Object.defineProperty;var m=(n,t,r)=>t in n?A(n,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):n[t]=r;var h=(n,t,r)=>(m(n,typeof t!="symbol"?t+"":t,r),r);import{u as d,k as S}from"./index.541f43d9.js";import{eventBus as u,EVENT_AUTH as f}from"./event-bus.a1695423.js";import{a as w}from"./axios.49e4da64.js";import{U as k,a as U,b as R}from"./ApiConstants.4dae4bb1.js";import{A as T}from"./index.e92490f7.js";import"./mitt.550594b0.js";class _{constructor(){}async fetchRefresh(t){const l=U+k,o=new AbortController,i=()=>{o.abort()};return{axiosPromise:w.post(l,void 0,{signal:o.signal,headers:{Authorization:`Bearer ${t}`}}).then(s=>{const a=s.status;if(a===401&&u.emit(f.REFRESH_TOKEN_UNVALIDATED),a===201){const c=s.data;return u.emit(f.REFRESH_TOKEN_REFRESHED,c),{status:a,data:c}}return{status:a,data:null}}),cancel:i}}}class P{constructor(){h(this,"userStore",d());h(this,"tokensAPi",new _)}validateExpiration(t,r){const o=Math.floor(Date.now()/1e3);if(o<t)return!1;const i=o-t,e=r-i;return i<r&&e>5}async extractAccessToken(){const t=this.userStore.$state.accessToken;return t?this.validateExpiration(t.iat,t.exp)?t.token:(this.userStore.clearAccessToken(),null):null}async extractRefreshToken(){const t=this.userStore.$state.refreshToken;return t?this.validateExpiration(t.iat,t.exp)?t.token:(this.userStore.clearRefreshToken(),null):null}async refreshTokens(){const t=await this.extractRefreshToken();if(!t)return u.emit(f.REFRESH_TOKEN_UNVALIDATED),null;const r=await this.tokensAPi.fetchRefresh(t),l=r.axiosPromise,o=r.cancel;return u.on(f.LOGOUT_SUCCESS,o),l.then(i=>(u.off(f.LOGOUT_SUCCESS,o),i.data))}async getAccessTokenAndRefresh(){const t=await this.extractAccessToken();if(t)return t;const r=await this.refreshTokens();return r?r.access_token.token:null}}var N=S(({app:n,store:t})=>{n.config.globalProperties.$api;const r=new P;async function l(e){const s=e.url;if(!e.baseURL||!s)throw new T(`axios:${e.baseURL,s}`);if(s===k)throw new T(k+" endpoint should not be fetched with this instance!");return e}async function o(e){var E;const s=e.params;if((E=s&&s[R])!=null?E:!1)return e;const c=await r.getAccessTokenAndRefresh();if(c)return e.headers.Authorization=`Bearer ${c}`,e;const p=new AbortController;return e.signal=p.signal,p.abort(),e}async function i(e){if(!e.params)return e;const a=Object.entries(e.params).filter(c=>c[0]!==R);return e.params=Object.fromEntries(a),e}n.config.globalProperties.$api.interceptors.request.use(async e=>{let s;return s=await l(e),s=await o(e),s=await i(e),s},e=>(console.error(e.toString()),Promise.reject(e))),n.config.globalProperties.$api.interceptors.response.use(e=>(console.log(e),e),e=>{if(console.log(e),e instanceof T){const s=e.response,a=s==null?void 0:s.status;a&&a===401&&r.refreshTokens()}return Promise.reject(e)})});export{N as default};
